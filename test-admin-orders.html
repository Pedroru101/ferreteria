<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Gestión de Pedidos en Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: var(--bg-primary);
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .test-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .test-section:last-child {
            border-bottom: none;
        }
        .test-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        .test-button {
            background: var(--primary);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .test-button:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }
        .test-output {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-primary);
            max-height: 300px;
            overflow-y: auto;
        }
        .test-success {
            color: #4caf50;
        }
        .test-error {
            color: #d32f2f;
        }
        .test-info {
            color: #0288d1;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Test - Gestión de Pedidos en Admin</h1>
        
        <div class="test-section">
            <div class="test-title">1. Crear Datos de Prueba</div>
            <button class="test-button" onclick="createTestOrders()">
                <i class="fas fa-plus"></i> Crear Pedidos de Prueba
            </button>
            <button class="test-button" onclick="clearTestOrders()">
                <i class="fas fa-trash"></i> Limpiar Datos
            </button>
            <div id="output1" class="test-output"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. Verificar Filtros</div>
            <button class="test-button" onclick="testFilters()">
                <i class="fas fa-filter"></i> Probar Filtros
            </button>
            <div id="output2" class="test-output"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. Verificar Actualización de Estado</div>
            <button class="test-button" onclick="testStatusUpdate()">
                <i class="fas fa-edit"></i> Probar Actualización de Estado
            </button>
            <div id="output3" class="test-output"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. Abrir Panel de Admin</div>
            <button class="test-button" onclick="openAdminPanel()">
                <i class="fas fa-external-link-alt"></i> Abrir Admin
            </button>
        </div>
    </div>

    <script src="js/products-data.js"></script>
    <script src="js/orders.js"></script>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString('es-AR');
            const className = `test-${type}`;
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function createTestOrders() {
            const output = 'output1';
            log(output, 'Creando pedidos de prueba...', 'info');

            const testOrders = [
                {
                    id: 'ORD-20240115-0001',
                    quotationId: 'COT-1705315800000-123',
                    date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    customer: {
                        name: 'Juan Pérez',
                        phone: '+54 9 11 1234-5678',
                        email: 'juan@example.com',
                        address: 'Calle Falsa 123, Mar del Plata',
                        installationDate: '2024-01-20'
                    },
                    items: [
                        { id: 'prod_001', name: 'Poste de Hormigón 2.5m', quantity: 10, unitPrice: 3500, subtotal: 35000 },
                        { id: 'prod_002', name: 'Alambre Galvanizado 2.4mm', quantity: 5, unitPrice: 2500, subtotal: 12500 }
                    ],
                    installation: { linearMeters: 100, pricePerMeter: 500, subtotal: 50000 },
                    subtotal: 97500,
                    total: 97500,
                    status: 'pending',
                    statusHistory: [
                        { status: 'pending', date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), note: 'Pedido creado' }
                    ]
                },
                {
                    id: 'ORD-20240116-0002',
                    quotationId: 'COT-1705402200000-456',
                    date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                    customer: {
                        name: 'María García',
                        phone: '+54 9 11 9876-5432',
                        email: 'maria@example.com',
                        address: 'Avenida Principal 456, Mar del Plata'
                    },
                    items: [
                        { id: 'prod_003', name: 'Poste de Quebracho 3m', quantity: 8, unitPrice: 4200, subtotal: 33600 }
                    ],
                    installation: null,
                    subtotal: 33600,
                    total: 33600,
                    status: 'confirmed',
                    statusHistory: [
                        { status: 'pending', date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), note: 'Pedido creado' },
                        { status: 'confirmed', date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), note: 'Confirmado por cliente' }
                    ]
                },
                {
                    id: 'ORD-20240117-0003',
                    quotationId: 'COT-1705488600000-789',
                    date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    customer: {
                        name: 'Carlos López',
                        phone: '+54 9 11 5555-1111',
                        email: 'carlos@example.com',
                        address: 'Calle Secundaria 789, Mar del Plata'
                    },
                    items: [
                        { id: 'prod_004', name: 'Tejido Romboidal 1.50m', quantity: 20, unitPrice: 1500, subtotal: 30000 }
                    ],
                    installation: { linearMeters: 150, pricePerMeter: 500, subtotal: 75000 },
                    subtotal: 105000,
                    total: 105000,
                    status: 'in_progress',
                    statusHistory: [
                        { status: 'pending', date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), note: 'Pedido creado' },
                        { status: 'confirmed', date: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(), note: 'Confirmado' },
                        { status: 'in_progress', date: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), note: 'En proceso de instalación' }
                    ]
                }
            ];

            localStorage.setItem('ferreteria_orders', JSON.stringify(testOrders));
            log(output, `✓ ${testOrders.length} pedidos de prueba creados exitosamente`, 'success');
            log(output, `Total guardado en localStorage: ${localStorage.getItem('ferreteria_orders').length} bytes`, 'info');
        }

        function clearTestOrders() {
            const output = 'output1';
            localStorage.removeItem('ferreteria_orders');
            log(output, '✓ Datos de prueba eliminados', 'success');
        }

        function testFilters() {
            const output = 'output2';
            log(output, 'Probando filtros...', 'info');

            const orders = JSON.parse(localStorage.getItem('ferreteria_orders') || '[]');
            
            if (orders.length === 0) {
                log(output, '✗ No hay pedidos. Crea datos de prueba primero.', 'error');
                return;
            }

            // Filtro por estado
            const pendingOrders = orders.filter(o => o.status === 'pending');
            log(output, `✓ Filtro por estado 'pending': ${pendingOrders.length} pedidos encontrados`, 'success');

            // Filtro por cliente
            const juanOrders = orders.filter(o => o.customer.name.toLowerCase().includes('juan'));
            log(output, `✓ Filtro por cliente 'juan': ${juanOrders.length} pedidos encontrados`, 'success');

            // Filtro por rango de fechas
            const now = new Date();
            const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
            const recentOrders = orders.filter(o => new Date(o.date) >= threeDaysAgo);
            log(output, `✓ Filtro por fecha (últimos 3 días): ${recentOrders.length} pedidos encontrados`, 'success');

            // Filtro combinado
            const filtered = orders.filter(o => 
                o.status === 'confirmed' && 
                new Date(o.date) >= threeDaysAgo
            );
            log(output, `✓ Filtro combinado (confirmados en últimos 3 días): ${filtered.length} pedidos encontrados`, 'success');
        }

        function testStatusUpdate() {
            const output = 'output3';
            log(output, 'Probando actualización de estado...', 'info');

            const orders = JSON.parse(localStorage.getItem('ferreteria_orders') || '[]');
            
            if (orders.length === 0) {
                log(output, '✗ No hay pedidos. Crea datos de prueba primero.', 'error');
                return;
            }

            const order = orders[0];
            const oldStatus = order.status;
            const newStatus = 'completed';

            order.status = newStatus;
            order.statusHistory.push({
                status: newStatus,
                date: new Date().toISOString(),
                note: 'Actualizado desde test'
            });

            localStorage.setItem('ferreteria_orders', JSON.stringify(orders));

            log(output, `✓ Estado actualizado: ${oldStatus} → ${newStatus}`, 'success');
            log(output, `✓ Historial de estados: ${order.statusHistory.length} registros`, 'success');
            log(output, `✓ Pedido: ${order.id}`, 'info');
        }

        function openAdminPanel() {
            window.open('admin.html', '_blank');
        }

        // Inicializar
        log('output1', 'Sistema de prueba listo', 'info');
    </script>
</body>
</html>
