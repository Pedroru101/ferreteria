<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Recarga de Google Sheets</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        body {
            padding: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        .test-section {
            margin-bottom: 30px;
        }
        .test-section h2 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-result.success {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4caf50;
            color: #2d7a3e;
        }
        .test-result.error {
            background: rgba(211, 47, 47, 0.1);
            border-color: #d32f2f;
            color: #d32f2f;
        }
        .test-result.info {
            background: rgba(2, 136, 209, 0.1);
            border-color: #0288d1;
            color: #0288d1;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .code-block {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-cloud"></i> Test - Recarga de Cache de Google Sheets</h1>

        <div class="test-section">
            <h2>1. Verificación de Configuración</h2>
            <div id="configCheck"></div>
        </div>

        <div class="test-section">
            <h2>2. Verificación de ProductsLoader</h2>
            <div id="loaderCheck"></div>
        </div>

        <div class="test-section">
            <h2>3. Verificación de localStorage</h2>
            <div id="storageCheck"></div>
        </div>

        <div class="test-section">
            <h2>4. Prueba de Recarga</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="testReload()">
                    <i class="fas fa-sync"></i> Simular Recarga
                </button>
                <button class="btn-secondary" onclick="clearTimestamp()">
                    <i class="fas fa-trash"></i> Limpiar Timestamp
                </button>
                <button class="btn-secondary" onclick="location.reload()">
                    <i class="fas fa-refresh"></i> Recargar Página
                </button>
            </div>
            <div id="reloadResult" style="margin-top: 20px;"></div>
        </div>

        <div class="test-section">
            <h2>5. Información de Almacenamiento</h2>
            <div id="storageInfo"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="products-loader.js"></script>

    <script>
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            container.appendChild(result);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // Test 1: Verificación de Configuración
        function checkConfig() {
            clearResults('configCheck');
            
            if (typeof CONFIG === 'undefined') {
                addResult('configCheck', 'CONFIG no está definido', 'error');
                return;
            }

            addResult('configCheck', 'CONFIG está definido', 'success');

            if (CONFIG.products.enableGoogleSheets) {
                addResult('configCheck', 'Google Sheets está HABILITADO', 'success');
                
                if (CONFIG.products.spreadsheetId) {
                    addResult('configCheck', `Spreadsheet ID: ${CONFIG.products.spreadsheetId}`, 'info');
                } else {
                    addResult('configCheck', 'Falta spreadsheetId en la configuración', 'error');
                }

                if (CONFIG.products.apiKey) {
                    addResult('configCheck', 'API Key está configurada', 'success');
                } else {
                    addResult('configCheck', 'Falta apiKey en la configuración', 'error');
                }
            } else {
                addResult('configCheck', 'Google Sheets está DESHABILITADO', 'info');
            }
        }

        // Test 2: Verificación de ProductsLoader
        function checkLoader() {
            clearResults('loaderCheck');

            if (typeof ProductsLoader === 'undefined') {
                addResult('loaderCheck', 'Clase ProductsLoader no está definida', 'error');
                return;
            }

            addResult('loaderCheck', 'Clase ProductsLoader está definida', 'success');

            if (typeof productsLoader === 'undefined') {
                addResult('loaderCheck', 'Instancia productsLoader no está definida', 'error');
                return;
            }

            addResult('loaderCheck', 'Instancia productsLoader está disponible', 'success');

            if (typeof productsLoader.reloadAll === 'function') {
                addResult('loaderCheck', 'Método reloadAll está disponible', 'success');
            } else {
                addResult('loaderCheck', 'Método reloadAll no está disponible', 'error');
            }

            if (typeof productsLoader.clearCache === 'function') {
                addResult('loaderCheck', 'Método clearCache está disponible', 'success');
            } else {
                addResult('loaderCheck', 'Método clearCache no está disponible', 'error');
            }
        }

        // Test 3: Verificación de localStorage
        function checkStorage() {
            clearResults('storageCheck');

            const timestamp = localStorage.getItem('ferreteria_sheets_last_update');
            
            if (timestamp) {
                const date = new Date(timestamp);
                addResult('storageCheck', `Timestamp encontrado: ${date.toLocaleString('es-AR')}`, 'success');
            } else {
                addResult('storageCheck', 'No hay timestamp guardado aún', 'info');
            }

            const cacheKey = 'ferreteria_sheets_cache';
            const cache = localStorage.getItem(cacheKey);
            if (cache) {
                addResult('storageCheck', `Cache de Google Sheets encontrado (${(cache.length / 1024).toFixed(2)} KB)`, 'success');
            } else {
                addResult('storageCheck', 'No hay cache de Google Sheets', 'info');
            }
        }

        // Test 4: Simular Recarga
        function testReload() {
            clearResults('reloadResult');
            addResult('reloadResult', 'Simulando recarga...', 'info');

            if (!CONFIG.products.enableGoogleSheets) {
                addResult('reloadResult', 'Google Sheets no está habilitado. Simulando guardado de timestamp...', 'info');
            }

            const timestamp = new Date().toISOString();
            localStorage.setItem('ferreteria_sheets_last_update', timestamp);
            
            const date = new Date(timestamp);
            addResult('reloadResult', `Timestamp guardado: ${date.toLocaleString('es-AR')}`, 'success');

            setTimeout(() => {
                checkStorage();
            }, 500);
        }

        // Limpiar Timestamp
        function clearTimestamp() {
            localStorage.removeItem('ferreteria_sheets_last_update');
            addResult('reloadResult', 'Timestamp eliminado', 'success');
            setTimeout(() => {
                checkStorage();
            }, 500);
        }

        // Test 5: Información de Almacenamiento
        function showStorageInfo() {
            clearResults('storageInfo');

            const storageSize = Object.keys(localStorage).reduce((total, key) => {
                return total + localStorage.getItem(key).length;
            }, 0);

            addResult('storageInfo', `Tamaño total de localStorage: ${(storageSize / 1024).toFixed(2)} KB`, 'info');

            const ferreteriKeys = Object.keys(localStorage).filter(key => key.startsWith('ferreteria_'));
            addResult('storageInfo', `Claves de ferreteria: ${ferreteriKeys.length}`, 'info');

            ferreteriKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const size = (value.length / 1024).toFixed(2);
                addResult('storageInfo', `${key}: ${size} KB`, 'info');
            });
        }

        // Ejecutar tests al cargar
        window.addEventListener('load', () => {
            checkConfig();
            checkLoader();
            checkStorage();
            showStorageInfo();
        });
    </script>
</body>
</html>
