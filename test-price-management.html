<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Gestión de Precios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="config.js"></script>
    <style>
        body {
            padding: 20px;
            background: var(--bg-primary);
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .test-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }
        .test-section:last-child {
            border-bottom: none;
        }
        .test-result {
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }
        .test-result.pass {
            background: rgba(76, 175, 80, 0.15);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .test-result.fail {
            background: rgba(211, 47, 47, 0.15);
            color: #d32f2f;
            border: 1px solid rgba(211, 47, 47, 0.3);
        }
        .test-result.info {
            background: rgba(2, 136, 209, 0.15);
            color: #0288d1;
            border: 1px solid rgba(2, 136, 209, 0.3);
        }
        h2 {
            color: var(--text-primary);
            font-size: 20px;
            margin-bottom: 16px;
        }
        h3 {
            color: var(--text-secondary);
            font-size: 16px;
            margin-top: 16px;
            margin-bottom: 12px;
        }
        .btn-test {
            background: var(--gradient-primary);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .btn-test:hover {
            opacity: 0.9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background: var(--bg-secondary);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Test - Gestión de Precios</h1>
        
        <div class="test-section">
            <h2>1. Pruebas de Datos de Productos</h2>
            <button class="btn-test" onclick="testLoadProducts()">Cargar Productos</button>
            <button class="btn-test" onclick="testGetCategories()">Obtener Categorías</button>
            <div id="testLoadProductsResult"></div>
            <div id="testGetCategoriesResult"></div>
        </div>

        <div class="test-section">
            <h2>2. Pruebas de Edición Individual de Precios</h2>
            <button class="btn-test" onclick="testEditIndividualPrice()">Editar Precio Individual</button>
            <div id="testEditIndividualPriceResult"></div>
        </div>

        <div class="test-section">
            <h2>3. Pruebas de Ajuste Masivo por Porcentaje</h2>
            <button class="btn-test" onclick="testBulkAdjustmentPercentage()">Ajuste Masivo (+10%)</button>
            <button class="btn-test" onclick="testBulkAdjustmentNegativePercentage()">Ajuste Masivo (-5%)</button>
            <div id="testBulkAdjustmentPercentageResult"></div>
            <div id="testBulkAdjustmentNegativePercentageResult"></div>
        </div>

        <div class="test-section">
            <h2>4. Pruebas de Ajuste Masivo por Cantidad Fija</h2>
            <button class="btn-test" onclick="testBulkAdjustmentFixed()">Ajuste Masivo (+500 ARS)</button>
            <button class="btn-test" onclick="testBulkAdjustmentFixedNegative()">Ajuste Masivo (-200 ARS)</button>
            <div id="testBulkAdjustmentFixedResult"></div>
            <div id="testBulkAdjustmentFixedNegativeResult"></div>
        </div>

        <div class="test-section">
            <h2>5. Pruebas de Persistencia en localStorage</h2>
            <button class="btn-test" onclick="testLocalStoragePersistence()">Verificar Persistencia</button>
            <div id="testLocalStoragePersistenceResult"></div>
        </div>

        <div class="test-section">
            <h2>6. Pruebas de Validación</h2>
            <button class="btn-test" onclick="testValidation()">Validar Precios</button>
            <div id="testValidationResult"></div>
        </div>

        <div class="test-section">
            <h2>7. Pruebas de Categorías</h2>
            <button class="btn-test" onclick="testCategoryFiltering()">Filtrar por Categoría</button>
            <div id="testCategoryFilteringResult"></div>
        </div>

        <div class="test-section">
            <h2>8. Resumen de Productos Actuales</h2>
            <button class="btn-test" onclick="displayProductsSummary()">Mostrar Resumen</button>
            <div id="productsSummary"></div>
        </div>
    </div>

    <script src="js/products-data.js"></script>
    <script>
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(value);
        }

        function getProducts() {
            const data = localStorage.getItem('ferreteria_products');
            return data ? JSON.parse(data) : (typeof PRODUCTS_DATA !== 'undefined' ? PRODUCTS_DATA : []);
        }

        function saveProducts(products) {
            localStorage.setItem('ferreteria_products', JSON.stringify(products));
        }

        function testLoadProducts() {
            const result = document.getElementById('testLoadProductsResult');
            try {
                const products = getProducts();
                if (products.length > 0) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Se cargaron ${products.length} productos correctamente
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="test-result fail">
                            <i class="fas fa-times-circle"></i> FAIL: No se encontraron productos
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="test-result fail">
                        <i class="fas fa-times-circle"></i> FAIL: ${error.message}
                    </div>
                `;
            }
        }

        function testGetCategories() {
            const result = document.getElementById('testGetCategoriesResult');
            try {
                const products = getProducts();
                const categories = new Set();
                products.forEach(p => {
                    if (p.category) categories.add(p.category);
                });
                const categoryArray = Array.from(categories);
                
                if (categoryArray.length > 0) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Se encontraron ${categoryArray.length} categorías: ${categoryArray.join(', ')}
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="test-result fail">
                            <i class="fas fa-times-circle"></i> FAIL: No se encontraron categorías
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="test-result fail">
                        <i class="fas fa-times-circle"></i> FAIL: ${error.message}
                    </div>
                `;
            }
        }

        function testEditIndividualPrice() {
            const result = document.getElementById('testEditIndividualPriceResult');
            try {
                const products = getProducts();
                if (products.length === 0) {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: No hay productos</div>`;
                    return;
                }

                const product = products[0];
                const oldPrice = product.price;
                const newPrice = oldPrice * 1.15;
                product.price = newPrice;
                product.updatedAt = new Date().toISOString();
                saveProducts(products);

                const savedProducts = getProducts();
                const savedProduct = savedProducts.find(p => p.id === product.id);

                if (savedProduct && Math.abs(savedProduct.price - newPrice) < 0.01) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Precio actualizado correctamente
                            <br>Producto: ${product.name}
                            <br>Precio anterior: ${formatCurrency(oldPrice)} → Nuevo: ${formatCurrency(newPrice)}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: El precio no se guardó correctamente</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testBulkAdjustmentPercentage() {
            const result = document.getElementById('testBulkAdjustmentPercentageResult');
            try {
                const products = getProducts();
                if (products.length === 0) {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: No hay productos</div>`;
                    return;
                }

                const category = products[0].category;
                const targetProducts = products.filter(p => p.category === category);
                const oldPrices = targetProducts.map(p => p.price);
                const adjustment = 10;

                targetProducts.forEach(p => {
                    p.price = p.price * (1 + adjustment / 100);
                    p.updatedAt = new Date().toISOString();
                });

                saveProducts(products);

                const savedProducts = getProducts();
                const savedTargetProducts = savedProducts.filter(p => p.category === category);
                let allCorrect = true;

                savedTargetProducts.forEach((p, i) => {
                    const expectedPrice = oldPrices[i] * (1 + adjustment / 100);
                    if (Math.abs(p.price - expectedPrice) > 0.01) {
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Ajuste masivo (+${adjustment}%) aplicado correctamente
                            <br>Productos afectados: ${targetProducts.length}
                            <br>Categoría: ${category}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: El ajuste no se aplicó correctamente</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testBulkAdjustmentNegativePercentage() {
            const result = document.getElementById('testBulkAdjustmentNegativePercentageResult');
            try {
                const products = getProducts();
                if (products.length === 0) {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: No hay productos</div>`;
                    return;
                }

                const category = products[0].category;
                const targetProducts = products.filter(p => p.category === category);
                const oldPrices = targetProducts.map(p => p.price);
                const adjustment = -5;

                targetProducts.forEach(p => {
                    p.price = Math.max(0, p.price * (1 + adjustment / 100));
                    p.updatedAt = new Date().toISOString();
                });

                saveProducts(products);

                const savedProducts = getProducts();
                const savedTargetProducts = savedProducts.filter(p => p.category === category);
                let allCorrect = true;

                savedTargetProducts.forEach((p, i) => {
                    const expectedPrice = Math.max(0, oldPrices[i] * (1 + adjustment / 100));
                    if (Math.abs(p.price - expectedPrice) > 0.01) {
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Ajuste masivo (${adjustment}%) aplicado correctamente
                            <br>Productos afectados: ${targetProducts.length}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: El ajuste no se aplicó correctamente</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testBulkAdjustmentFixed() {
            const result = document.getElementById('testBulkAdjustmentFixedResult');
            try {
                const products = getProducts();
                if (products.length === 0) {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: No hay productos</div>`;
                    return;
                }

                const category = products[0].category;
                const targetProducts = products.filter(p => p.category === category);
                const oldPrices = targetProducts.map(p => p.price);
                const adjustment = 500;

                targetProducts.forEach(p => {
                    p.price = Math.max(0, p.price + adjustment);
                    p.updatedAt = new Date().toISOString();
                });

                saveProducts(products);

                const savedProducts = getProducts();
                const savedTargetProducts = savedProducts.filter(p => p.category === category);
                let allCorrect = true;

                savedTargetProducts.forEach((p, i) => {
                    const expectedPrice = Math.max(0, oldPrices[i] + adjustment);
                    if (Math.abs(p.price - expectedPrice) > 0.01) {
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Ajuste masivo (+${formatCurrency(adjustment)}) aplicado correctamente
                            <br>Productos afectados: ${targetProducts.length}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: El ajuste no se aplicó correctamente</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testBulkAdjustmentFixedNegative() {
            const result = document.getElementById('testBulkAdjustmentFixedNegativeResult');
            try {
                const products = getProducts();
                if (products.length === 0) {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: No hay productos</div>`;
                    return;
                }

                const category = products[0].category;
                const targetProducts = products.filter(p => p.category === category);
                const oldPrices = targetProducts.map(p => p.price);
                const adjustment = -200;

                targetProducts.forEach(p => {
                    p.price = Math.max(0, p.price + adjustment);
                    p.updatedAt = new Date().toISOString();
                });

                saveProducts(products);

                const savedProducts = getProducts();
                const savedTargetProducts = savedProducts.filter(p => p.category === category);
                let allCorrect = true;

                savedTargetProducts.forEach((p, i) => {
                    const expectedPrice = Math.max(0, oldPrices[i] + adjustment);
                    if (Math.abs(p.price - expectedPrice) > 0.01) {
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Ajuste masivo (${formatCurrency(adjustment)}) aplicado correctamente
                            <br>Productos afectados: ${targetProducts.length}
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: El ajuste no se aplicó correctamente</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testLocalStoragePersistence() {
            const result = document.getElementById('testLocalStoragePersistenceResult');
            try {
                const products = getProducts();
                const testProduct = products[0];
                const originalPrice = testProduct.price;
                
                testProduct.price = 9999;
                saveProducts(products);

                const reloadedProducts = getProducts();
                const reloadedProduct = reloadedProducts.find(p => p.id === testProduct.id);

                if (reloadedProduct && reloadedProduct.price === 9999) {
                    reloadedProduct.price = originalPrice;
                    saveProducts(reloadedProducts);
                    
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Los datos se persisten correctamente en localStorage
                        </div>
                    `;
                } else {
                    result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: Los datos no se persistieron</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testValidation() {
            const result = document.getElementById('testValidationResult');
            try {
                const products = getProducts();
                let validCount = 0;
                let invalidCount = 0;

                products.forEach(p => {
                    if (typeof p.price === 'number' && p.price >= 0 && p.id && p.name) {
                        validCount++;
                    } else {
                        invalidCount++;
                    }
                });

                if (invalidCount === 0) {
                    result.innerHTML = `
                        <div class="test-result pass">
                            <i class="fas fa-check-circle"></i> PASS: Todos los ${validCount} productos tienen precios válidos
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="test-result fail">
                            <i class="fas fa-times-circle"></i> FAIL: ${invalidCount} productos tienen precios inválidos
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function testCategoryFiltering() {
            const result = document.getElementById('testCategoryFilteringResult');
            try {
                const products = getProducts();
                const categories = new Set();
                products.forEach(p => {
                    if (p.category) categories.add(p.category);
                });

                let html = '<div class="test-result info"><i class="fas fa-info-circle"></i> Productos por categoría:<br><table>';
                html += '<tr><th>Categoría</th><th>Cantidad</th><th>Precio Promedio</th></tr>';

                categories.forEach(cat => {
                    const catProducts = products.filter(p => p.category === cat);
                    const avgPrice = catProducts.reduce((sum, p) => sum + p.price, 0) / catProducts.length;
                    html += `<tr><td>${cat}</td><td>${catProducts.length}</td><td>${formatCurrency(avgPrice)}</td></tr>`;
                });

                html += '</table></div>';
                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        function displayProductsSummary() {
            const summary = document.getElementById('productsSummary');
            try {
                const products = getProducts();
                let html = '<div class="test-result info"><i class="fas fa-info-circle"></i> Resumen de Productos:<br><table>';
                html += '<tr><th>Nombre</th><th>Categoría</th><th>Precio</th><th>Stock</th></tr>';

                products.slice(0, 10).forEach(p => {
                    html += `<tr><td>${p.name}</td><td>${p.category || 'N/A'}</td><td>${formatCurrency(p.price)}</td><td>${p.stock || 0}</td></tr>`;
                });

                if (products.length > 10) {
                    html += `<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">... y ${products.length - 10} más</td></tr>`;
                }

                html += '</table></div>';
                summary.innerHTML = html;
            } catch (error) {
                summary.innerHTML = `<div class="test-result fail"><i class="fas fa-times-circle"></i> FAIL: ${error.message}</div>`;
            }
        }

        window.addEventListener('load', () => {
            testLoadProducts();
            testGetCategories();
        });
    </script>
</body>
</html>
